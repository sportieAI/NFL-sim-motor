name: CI

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [main]
  push:
    branches: [main]

jobs:
  lint-and-test:
    name: Lint and unit tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: [ "3.10", "3.11", "3.12" ]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt || true

      - name: Lint (flake8)
        run: |
          pip install flake8
          flake8 .

      - name: Run unit tests (pytest)
        run: |
          pip install pytest pytest-cov
          pytest -q --disable-warnings --maxfail=1 --cov=.

  schema-validation:
    name: Schema validation
    runs-on: ubuntu-latest
    needs: lint-and-test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pydantic jsonschema deepdiff

      - name: Validate schemas
        run: |
          python scripts/validate_schemas.py

  golden-run:
    name: Golden-run comparisons
    runs-on: ubuntu-latest
    needs: [lint-and-test, schema-validation]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install deepdiff

      - name: Run simulation (PR)
        env:
          SIM_SEED: "week1-2025-baseline"
        run: |
          python scripts/run_simulation.py --seed "$SIM_SEED" --output pr_simulation_results.json

      # Compare against 2007 Patriots baseline
      - name: Compare vs 2007 baseline
        run: |
          python scripts/compare_golden.py \
            --baseline tests/golden_runs/2007-pats-drive-01.json \
            --candidate pr_simulation_results.json \
            --tolerance-points 0.5 \
            --tolerance-winprob 0.02
      - name: Rename 2007 drift CSV
        run: mv drift_diagnostics.csv drift_diagnostics_2007.csv

      # Compare against Week 1 2025 baseline
      - name: Compare vs Week1 2025 baseline
        run: |
          python scripts/compare_golden.py \
            --baseline tests/golden_runs/week1-2025-baseline.json \
            --candidate pr_simulation_results.json \
            --tolerance-points 0.5 \
            --tolerance-winprob 0.02
      - name: Rename Week1 drift CSV
        run: mv drift_diagnostics.csv drift_diagnostics_week1.csv

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pr-simulation-artifacts
          path: |
            pr_simulation_results.json
            comparison_report.md
            drift_diagnostics_2007.csv
            drift_diagnostics_week1.csv
