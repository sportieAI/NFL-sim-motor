name: CI

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [main]
  push:
    branches: [main]

jobs:
  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      python_matrix: ${{ steps.set-matrix.outputs.python_matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set Python matrix
        id: set-matrix
        run: |
          echo 'python_matrix=["3.10","3.11","3.12"]' >> $GITHUB_OUTPUT

  lint-and-test:
    name: Lint and unit tests
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ${{ fromJson(needs.setup.outputs.python_matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt || true

      - name: Lint (flake8)
        run: |
          pip install flake8
          flake8 .

      - name: Run unit tests (pytest)
        env:
          PYTHONWARNINGS: default
        run: |
          pip install pytest pytest-cov
          pytest -q --disable-warnings --maxfail=1 --cov=.

  schema-validation:
    name: Schema validation
    runs-on: ubuntu-latest
    needs: lint-and-test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pydantic jsonschema deepdiff

      - name: Validate schemas and contracts
        run: |
          python scripts/validate_schemas.py

  golden-run:
    name: Golden-run comparison
    runs-on: ubuntu-latest
    needs: [lint-and-test, schema-validation]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install deepdiff

      - name: Run simulation (PR)
        env:
          SIM_SEED: "2007-pats-drive-01"
          SIM_TOLERANCE_POINTS: "0.5"
          SIM_TOLERANCE_WINPROB: "0.02"
        run: |
          python scripts/run_simulation.py --seed "$SIM_SEED" --output pr_simulation_results.json

      - name: Compare against golden baseline
        run: |
          python scripts/compare_golden.py \
            --baseline tests/golden_runs/2007-pats-drive-01.json \
            --candidate pr_simulation_results.json \
            --tolerance-points "$SIM_TOLERANCE_POINTS" \
            --tolerance-winprob "$SIM_TOLERANCE_WINPROB"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pr-simulation-artifacts
          path: |
            pr_simulation_results.json
            comparison_report.md

  docs-infra-automerge:
    name: Automerge docs/infra (label-gated)
    runs-on: ubuntu-latest
    needs: [golden-run]
    if: |
      github.event_name == 'pull_request' &&
      contains(github.event.pull_request.labels.*.name, 'automerge') &&
      !cancelled() && !failure()
    steps:
      - name: Check changed paths are docs/infra only
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            docs:
              - 'README.md'
              - 'ONBOARDING.md'
              - 'QUICKSTART.md'
              - 'docs/**'
            infra:
              - '.github/**'
              - 'docker/**'
              - 'scripts/**'
            simulation_core:
              - 'main_sim_loop.py'
              - 'simulate_play.py'
              - 'state_updater.py'
              - 'validators.py'
              - 'strategic_cognition.py'
              - 'Agent.py'
              - 'agent.py'
              - 'schemas/**'
              - 'data_pipeline.py'

      - name: Fail if simulation core touched
        if: steps.changes.outputs.simulation_core == 'true'
        run: |
          echo "Simulation core files changed; automerge not allowed."
          exit 1

      - name: Enable auto-merge
        run: |
          gh pr merge "$PR_NUMBER" --merge --auto
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
